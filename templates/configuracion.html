<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <!-- META TAG VITAL PARA M√ìVILES -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Admin - Herboli Naz</title>
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <style>
    /* ===== ESTILO UNIFICADO (ECOVIVERO) ===== */
    :root {
      --verde-oscuro: #2e523e;
      --verde: #4a7856;
      --verde-claro: #cfdec4;
      --beige: #F9F7F2;
      --blanco: #ffffff;
      --texto: #2c3e33;
      --radius: 20px;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, rgba(46, 82, 62, 0.85) 0%, rgba(74, 120, 86, 0.5) 100%),
                  url('{{ url_for("static", filename="images/vivero-bg.jpg") }}') center/cover no-repeat;
      background-attachment: fixed;
      color: var(--texto);
      min-height: 100vh;
      padding-top: 80px;
      padding-bottom: 40px;
    }

    /* ===== NAVBAR ===== */
    .navbar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      padding: 10px 0;
    }
    .navbar-brand {
      font-weight: 800;
      color: var(--verde-oscuro) !important;
      font-size: 1.3rem;
      display: flex; align-items: center; gap: 10px;
    }
    .nav-link { color: var(--texto) !important; font-weight: 500; }
    .navbar-toggler { border: none; padding: 0; }

    /* ===== CONTENEDORES (TARJETAS) ===== */
    .admin-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 30px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }

    .section-title {
      color: var(--verde-oscuro);
      font-weight: 800;
      border-bottom: 2px solid var(--verde-claro);
      padding-bottom: 15px;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ===== FORMULARIOS ===== */
    label {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--verde);
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-control {
      background-color: var(--beige);
      border: 1px solid transparent;
      border-radius: 15px;
      padding: 10px 15px;
      color: var(--texto);
    }

    .form-control:focus {
      background-color: var(--blanco);
      border-color: var(--verde);
      box-shadow: 0 0 0 3px rgba(74, 120, 86, 0.1);
    }

    /* Input de archivo personalizado */
    input[type="file"]::file-selector-button {
      background-color: var(--verde);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 10px;
      cursor: pointer;
      margin-right: 10px;
      transition: 0.3s;
    }
    input[type="file"]::file-selector-button:hover {
      background-color: var(--verde-oscuro);
    }

    /* ===== BOTONES DE NAVEGACI√ìN R√ÅPIDA ===== */
    .nav-pills .nav-link {
      background: rgba(255,255,255,0.2);
      color: var(--blanco);
      border: 1px solid rgba(255,255,255,0.4);
      margin: 0 5px 10px;
      border-radius: 50px;
      padding: 8px 20px;
    }
    .nav-pills .nav-link:hover, .nav-pills .nav-link.active {
      background: var(--blanco);
      color: var(--verde-oscuro);
      font-weight: 700;
    }

    /* ===== TABLAS ===== */
    .table-responsive {
      border-radius: 15px;
      overflow: hidden;
    }
    .table thead {
      background-color: var(--verde-oscuro);
      color: var(--blanco);
    }
    .table th, .table td {
      vertical-align: middle;
    }

    /* ===== M√ìVIL ===== */
    @media (max-width: 768px) {
      body { background-attachment: scroll; }
      .admin-card { padding: 20px 15px; }
      .btn { width: 100%; margin-bottom: 5px; }
      /* Hacer que los botones de acci√≥n en formularios se apilen */
      .action-buttons { flex-direction: column; gap: 10px; }
    }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-gear-wide-connected"></i> Admin Panel
      </a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <i class="bi bi-list" style="font-size: 2.2rem; color: var(--verde-oscuro);"></i>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav align-items-center text-center">
          <li class="nav-item"><span class="nav-link fw-bold text-success">Hola, {{ usuario }}</span></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}">Ir al Inicio</a></li>
          <li class="nav-item mt-2 mt-lg-0 ms-lg-2">
            <a class="btn btn-outline-danger rounded-pill px-4" href="{{ url_for('logout') }}">Salir</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    
    <!-- MEN√ö DE NAVEGACI√ìN R√ÅPIDA -->
    <div class="d-flex justify-content-center flex-wrap mb-4">
      <div class="nav nav-pills">
        <a class="nav-link" href="#clientes"><i class="bi bi-people-fill"></i> Clientes</a>
        <a class="nav-link" href="#productos"><i class="bi bi-flower1"></i> Productos</a>
        <a class="nav-link" href="{{ url_for('admin_compras') }}"><i class="bi bi-bag-check-fill"></i> Compras</a>
        <a class="nav-link" href="{{ url_for('proveedores') }}"><i class="bi bi-truck"></i> Proveedores</a>
      </div>
    </div>

    <!-- SECCI√ìN CLIENTES -->
    <section id="clientes" class="admin-card">
      <h3 class="section-title"><i class="bi bi-person-badge"></i> Gesti√≥n de Clientes</h3>
      
      <form id="clienteForm">
        <div class="row g-3">
          <div class="col-6 col-md-2">
            <label>ID Cliente</label>
            <input type="text" id="idCliente" class="form-control text-center fw-bold" placeholder="#" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
          </div>
          <div class="col-12 col-md-4">
            <label>Nombre Completo</label>
            <input type="text" id="nombre" class="form-control" placeholder="Nombre">
          </div>
          <div class="col-12 col-md-3">
            <label>Direcci√≥n</label>
            <input type="text" id="direccion" class="form-control" placeholder="Direcci√≥n">
          </div>
          <div class="col-12 col-md-3">
            <label>Tel√©fono</label>
            <input type="tel" id="telefono" class="form-control" placeholder="10 d√≠gitos">
          </div>
        </div>

        <div class="mt-4 d-flex justify-content-end gap-2 action-buttons">
          <button type="button" id="btnBuscarCliente" class="btn btn-info text-white rounded-pill"><i class="bi bi-search"></i> Buscar</button>
          <button type="button" id="btnModificarCliente" class="btn btn-warning text-white rounded-pill"><i class="bi bi-pencil"></i> Modificar</button>
          <button type="button" id="btnEliminarCliente" class="btn btn-danger rounded-pill"><i class="bi bi-trash"></i> Eliminar</button>
          <button type="button" id="btnGuardarCliente" class="btn btn-success rounded-pill"><i class="bi bi-check-lg"></i> Guardar Nuevo</button>
        </div>
      </form>

      <!-- Tabla Clientes -->
      <div class="mt-5">
        <h5 class="text-muted mb-3">Listado Reciente</h5>
        <div class="table-responsive shadow-sm">
          <table class="table table-hover mb-0 bg-white">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Direcci√≥n</th>
                <th>Tel√©fono</th>
              </tr>
            </thead>
            <tbody>
              {% for cliente in clientes %}
              <tr>
                <td class="fw-bold">{{ cliente.id }}</td>
                <td>{{ cliente.nombre }}</td>
                <td>{{ cliente.direccion }}</td>
                <td>{{ cliente.telefono }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SECCI√ìN PRODUCTOS (AQU√ç EST√Å EL CAMBIO DE IMAGEN) -->
    <section id="productos" class="admin-card">
      <h3 class="section-title"><i class="bi bi-tree"></i> Gesti√≥n de Productos</h3>
      <p class="small text-muted mb-4">Sube fotos directamente desde tu celular o computadora.</p>

      <!-- FORMULARIO AGREGAR (MULTIPART) -->
      <form method="post" action="{{ url_for('agregar_planta') }}" enctype="multipart/form-data" class="p-3 bg-light rounded-4 border">
        <h5 class="text-success fw-bold mb-3">üå± Agregar Nueva Planta</h5>
        
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label>Nombre de la Planta</label>
            <input type="text" name="nombre" class="form-control" required>
          </div>
          
          <div class="col-6 col-md-3">
            <label>Precio ($)</label>
            <input type="number" name="precio" class="form-control" required>
          </div>

          <!-- CAMBIO IMPORTANTE: INPUT FILE -->
          <div class="col-12 col-md-3">
            <label>Foto</label>
            <!-- accept="image/*" hace que en el cel abra la galer√≠a/c√°mara -->
            <input type="file" name="imagen" class="form-control" accept="image/*" required>
          </div>

          <div class="col-12">
            <label>Descripci√≥n</label>
            <textarea name="descripcion" class="form-control" rows="2" required></textarea>
          </div>
        </div>

        <div class="mt-3 text-end">
          <button type="submit" class="btn btn-dark rounded-pill px-4">
            <i class="bi bi-plus-lg"></i> Agregar al Cat√°logo
          </button>
        </div>
      </form>

      <hr class="my-5 opacity-25">

      <!-- LISTADO DE PRODUCTOS EXISTENTES -->
      <h5 class="text-muted mb-4">Cat√°logo Actual</h5>
      
      {% for planta in plantas %}
      <!-- Formulario individual para editar (MULTIPART TAMBI√âN) -->
      <form method="post" action="{{ url_for('administrar_plantas') }}" enctype="multipart/form-data" class="mb-4">
        <input type="hidden" name="id" value="{{ planta.id }}">
        
        <div class="card border-0 shadow-sm overflow-hidden">
          <div class="row g-0">
            <!-- Columna Imagen -->
            <div class="col-md-3 position-relative bg-light text-center p-2">
              <img src="{{ url_for('static', filename='images/' ~ planta.imagen) }}" 
                   alt="{{ planta.nombre }}" 
                   class="img-fluid rounded" 
                   style="max-height: 150px; object-fit: cover;">
              <div class="mt-2">
                <label class="small text-muted">Cambiar Foto:</label>
                <input type="file" name="imagen" class="form-control form-control-sm" accept="image/*">
                <!-- Input hidden para mantener la imagen vieja si no suben una nueva -->
                <input type="hidden" name="imagen_anterior" value="{{ planta.imagen }}">
              </div>
            </div>

            <!-- Columna Datos -->
            <div class="col-md-9">
              <div class="card-body">
                <div class="row g-2">
                  <div class="col-8">
                    <label>Nombre</label>
                    <input type="text" name="nombre" value="{{ planta.nombre }}" class="form-control">
                  </div>
                  <div class="col-4">
                    <label>Precio</label>
                    <input type="number" name="precio" value="{{ planta.precio }}" class="form-control">
                  </div>
                  <div class="col-12">
                    <label>Descripci√≥n</label>
                    <input type="text" name="descripcion" value="{{ planta.descripcion }}" class="form-control">
                  </div>
                </div>
                
                <div class="mt-3 d-flex justify-content-end gap-2">
                  <button type="submit" class="btn btn-sm btn-outline-success rounded-pill">
                    <i class="bi bi-save"></i> Guardar
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-danger rounded-pill btnEliminarPlanta" data-id="{{ planta.id }}">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
      {% endfor %}

    </section>

  </div>

  <!-- JAVASCRIPT -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // L√ìGICA DE CLIENTES (Fetch API)
    function getFormData() {
      return {
        idCliente: document.getElementById('idCliente').value.trim(),
        nombre: document.getElementById('nombre').value.trim(),
        direccion: document.getElementById('direccion').value.trim(),
        telefono: document.getElementById('telefono').value.trim()
      };
    }

    document.getElementById('btnBuscarCliente').addEventListener('click', () => {
      const { idCliente } = getFormData();
      if (!idCliente) return alert('‚ö†Ô∏è Ingresa un ID para buscar.');
      fetch('/cliente/buscar', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ idCliente })
      })
      .then(res => res.json())
      .then(data => {
        if (data.nombre) {
          document.getElementById('nombre').value = data.nombre;
          document.getElementById('direccion').value = data.direccion;
          document.getElementById('telefono').value = data.telefono;
          alert('‚úÖ Cliente encontrado.');
        } else { alert('‚ùå No encontrado.'); }
      });
    });

    document.getElementById('btnGuardarCliente').addEventListener('click', () => {
      const data = getFormData();
      if (!data.nombre) return alert('‚ö†Ô∏è Ingresa el nombre.');
      fetch('/cliente/guardar', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
      }).then(res => res.json()).then(r => { alert(r.mensaje); if(r.mensaje.includes('correctamente')) location.reload(); });
    });

    document.getElementById('btnEliminarCliente').addEventListener('click', () => {
      const { idCliente } = getFormData();
      if (!idCliente) return alert('‚ö†Ô∏è ID requerido.');
      if(confirm('¬øEliminar cliente?')) {
        fetch('/cliente/eliminar', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ idCliente })
        }).then(res => res.json()).then(r => { alert(r.mensaje); location.reload(); });
      }
    });
    
    // ELIMINAR PLANTA
    document.querySelectorAll('.btnEliminarPlanta').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        if(confirm('¬øEliminar planta?')) {
          fetch('/planta/eliminar', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id })
          }).then(res => res.json()).then(r => { alert(r.mensaje); location.reload(); });
        }
      });
    });
  </script>

</body>
</html>